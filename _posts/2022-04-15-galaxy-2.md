---
layout: splash
permalink: /galaxy-2/
title: "Exploring the Galaxy Zoo Dataset, Part II"
header:
  overlay_image: /assets/images/galaxy-2/galaxy-2-splash.jpeg
excerpt: "Building a CNN for the Galaxy Zoo competition."
---

```python
import matplotlib.pylab as plt
import numpy as np
import pandas as pd
from pathlib import Path
import random
import seaborn as sns
```


```python
IMG_DIR = Path(r'../2022-04-01-galaxy-1/data/images_training_rev1')
```


```python
labels = pd.read_csv('../2022-04-01-galaxy-1/data/training_solutions_rev1.csv')
print(f"Found {len(labels)} entries with {len(labels.columns)} columns.")
```

    Found 61578 entries with 38 columns.
    


```python
desc = [
    'Smooth', 'Featured or disc', 'Star or artifact',
    'Edge on', 'Not edge on',
    'Bar through center', 'No bar',
    'Spiral', 'No Spiral',
    'No bulge', 'Just noticeable bulge', 'Obvious bulge', 'Dominant bulge',
    'Odd Feature', 'No Odd Feature',
    'Completely round', 'In between', 'Cigar shaped',
    'Ring (Oddity)', 'Lens or arc (Oddity)', 'Disturbed (Oddity)', 'Irregular (Oddity)',
        'Other (Oddity)', 'Merger (Oddity)', 'Dust lane (Oddity)',
    'Rounded bulge', 'Boxy bulge', 'No bulge',
    'Tightly wound arms', 'Medium wound arms', 'Loose wound arms',
    '1 Spiral Arm', '2 Spiral Arms', '3 Spiral Arms', '4 Spiral Arms', 'More than four Spiral Arms', "Can't tell"
]
```


```python
from sklearn.model_selection import train_test_split
```


```python
X_train, X_test, Y_train, Y_test = \
    train_test_split(labels.GalaxyID, labels[labels.columns[1:]],  
                     test_size=0.20, random_state=42)
print(f"Training set size: {X_train.shape[0]}")
print(f"Testing set size: {X_test.shape[0]}")
```

    Training set size: 49262
    Testing set size: 12316
    


```python
import torch
from torchvision import transforms
from torchvision.transforms import Resize, Grayscale, functional
from torchvision.io import read_image
from sklearn.metrics import mean_squared_error
from PIL import Image
```


```python
class GalaxyDataset(torch.utils.data.Dataset):

    def __init__(self, X, Y, path, transform):
        self.X = X
        self.Y = Y
        self.path = path
        self.transform = transform

    def __len__(self):
        return len(self.X)
    
    def __getitem__(self, idx):
        img = Image.open(self.path / f'{self.X.iloc[idx]}.jpg')
        return self.transform(img), torch.FloatTensor(self.Y.iloc[idx])
```


```python
def get_transform(crop_and_resize, scale):
	if crop_and_resize:
		transform = [
			transforms.CenterCrop((207, 207)),
			transforms.Resize((69, 69)),
		]
	else:
		transform = []
	transform += [
		transforms.RandomHorizontalFlip(p=0.5),
		transforms.RandomRotation(degrees=(0,360)),
		transforms.RandomVerticalFlip(p=0.5),
		transforms.ToTensor(),
	]
	if scale:
		transform.append(transforms.Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225]))
	return transforms.Compose(transform)
```


```python
_ = torch.manual_seed(42)
```


```python
fig, axes = plt.subplots(figsize=(8, 24), nrows=6, ncols=2)
for i in range(6):
    img = GalaxyDataset(X_train, Y_train, IMG_DIR, get_transform(False, False))[i][0]
    img = img.permute(1, 2, 0)
    axes[i, 0].imshow(img)
    axes[i, 0].axis('off')
    axes[i, 0].text(25, 30, 'Original', color='white')
    img = GalaxyDataset(X_train, Y_train, IMG_DIR, get_transform(True, False))[i][0]
    img = img.permute(1, 2, 0)
    axes[i, 1].imshow(img)
    axes[i, 1].axis('off')
    axes[i, 1].text(5, 5, 'Cropped, resized, randomly rotated', color='white')
fig.tight_layout()
```


    
![png](/assets/images/galaxy-2/galaxy-2-1.png)
    


From https://github.com/jimsiak/kaggle-galaxies-pytorch/blob/master/:


```python
import torch.nn as nn
import torch.nn.functional as F

class SanderDielemanNet(nn.Module): 
	def __init__(self, num_classes=37): 
		super(SanderDielemanNet, self).__init__() 
		# Convolutional and MaxPool layers 
		self.conv1 = nn.Conv2d(3, 32, 6)
		self.pool1 = nn.MaxPool2d(kernel_size=2, stride=2)
		self.conv2 = nn.Conv2d(32, 64, 5)
		self.pool2 = nn.MaxPool2d(kernel_size=2, stride=2)
		self.conv3 = nn.Conv2d(64, 128, 3)
		self.conv4 = nn.Conv2d(128, 128, 3)
		self.pool4 = nn.MaxPool2d(kernel_size=2, stride=2)
		# Dense layers
		self.fc1 = nn.Linear(128 * 5 * 5, 128)
		self.fc2 = nn.Linear(128, 64)
		self.fc3 = nn.Linear(64, num_classes)

	def forward(self, x):
		batch_size = x.shape[0]
		# Convolutional and MaxPool layers 
		x = F.relu(self.conv1(x)) 
		x = self.pool1(x) 
		x = F.relu(self.conv2(x)) 
		x = self.pool2(x) 
		x = F.relu(self.conv3(x)) 
		x = F.relu(self.conv4(x)) 
		x = self.pool4(x)
		# Dense layers 
		x = x.view(batch_size, -1)
		x = F.relu(self.fc1(x)) 
		x = F.relu(self.fc2(x))
		x = F.relu(self.fc3(x)) 
		return(x)
```


```python
dataset_train = GalaxyDataset(X_train, Y_train, IMG_DIR, get_transform(True, True))
dataloader_train = torch.utils.data.DataLoader(dataset_train, batch_size=128)
dataset_test = GalaxyDataset(X_test, Y_test, IMG_DIR, get_transform(True, True))
dataloader_test = torch.utils.data.DataLoader(dataset_test, batch_size=128)
```


```python
device = 'cuda' if torch.cuda.is_available() else 'cpu'
```


```python
import torch.optim as optim
from torch.optim import lr_scheduler
model = SanderDielemanNet(num_classes=37).to(device)
criterion = nn.MSELoss(reduction='sum')
optimizer = optim.SGD(model.parameters(), lr=0.1, momentum=0.9)
scheduler = lr_scheduler.ReduceLROnPlateau(optimizer, 'min', verbose=True)
```


```python
import time
losses_train, losses_test = [], []
for epoch in range(1, 101):
    start_time = time.time()
    loss_train = 0.0
    for inputs, labels in dataloader_train:
        inputs, labels = inputs.to(device), labels.to(device)
        optimizer.zero_grad()
        outputs = model(inputs)
        loss = criterion(outputs, labels)
        loss_train += loss.item()
        loss /= np.product(outputs.shape)
        loss.backward()
        optimizer.step()
    loss_train = np.sqrt(loss_train / len(dataset_train) / 37)
    losses_train.append(loss_train)

    with torch.no_grad():
        loss_test = 0.0
        for inputs, labels in dataloader_test:
            inputs, labels = inputs.to(device), labels.to(device)
            outputs = model(inputs)
            loss = criterion(outputs, labels)
            loss_test += loss.item()
        loss_test = np.sqrt(loss_test / len(dataset_test) / 37)
        losses_test.append(loss_test)
    elapsed_time = time.time() - start_time
    #print(f'Epoch {epoch:4d}: loss train={loss_train:.4f}, loss_test={loss_test:.4f} [{elapsed_time:.2f} s]')
```


```python
plt.semilogy(losses_train, label='train')
plt.semilogy(losses_test, label='test')
plt.legend()
plt.xlabel('Epoch')
plt.ylabel('Los Loss')
```




    Text(0, 0.5, 'Los Loss')




    
![png](/assets/images/galaxy-2/galaxy-2-2.png)
    


The model converges nicely, with train and test sets giving similar losses. We can try the model on a few test sets and check the results. To do that, we put together a humna-readable description of the questions, grouped as needed, and look for the highest probably within each group.


```python
groups = [
    ['Smooth', 'Featured or disc', 'Star or artifact'],
    ['Edge on', 'Not edge on'],
    ['Bar through center', 'No bar'],
    ['Spiral', 'No Spiral'],
    ['No bulge', 'Just noticeable bulge', 'Obvious bulge', 'Dominant bulge'],
    ['Odd Feature', 'No Odd Feature'],
    ['Completely round', 'In between', 'Cigar shaped'],
    ['Ring (Oddity)', 'Lens or arc (Oddity)', 'Disturbed (Oddity)', 'Irregular (Oddity)',
        'Other (Oddity)', 'Merger (Oddity)', 'Dust lane (Oddity)'],
    ['Rounded bulge', 'Boxy bulge', 'No bulge'],
    ['Tightly wound arms', 'Medium wound arms', 'Loose wound arms'],
    ['1 Spiral Arm', '2 Spiral Arms', '3 Spiral Arms', '4 Spiral Arms', 'More than four Spiral Arms', "Can't tell"],
]
```


```python
for _ in range(10):
    i = random.randint(0, len(X_test))

    fig, (ax0, ax1) = plt.subplots(figsize=(8, 4), ncols=2)
    img = GalaxyDataset(X_test, Y_test, IMG_DIR, get_transform(False, False))[i][0]
    img = img.permute(1, 2, 0)
    ax0.imshow(img)
    ax0.axis('off')
    ax0.text(25, 30, f'i={i} Original', color='white')
    img = GalaxyDataset(X_test, Y_test, IMG_DIR, get_transform(True, False))[i][0]
    img = img.permute(1, 2, 0)
    ax1.imshow(img)
    ax1.axis('off')
    ax1.text(5, 5, 'Cropped, resized, randomly rotated', color='white')
    plt.show()

    X_i, Y_i = dataset_test[i]
    X_i = X_i.to(device)
    Y_pred_i = model(X_i.unsqueeze(0)).detach().cpu().squeeze(0)

    Y_i = pd.Series(Y_i, index=sum(desc, []))
    Y_pred_i = pd.Series(Y_pred_i, index=sum(desc, []))

    print('------|----------------------|----------------------|------')
    print(' prob |      meaning (exact) | meaning (pred)       | prob')
    print('------|----------------------|----------------------|------')
    for group in groups:
        S_i, S_pred_i = Y_i[group], Y_pred_i[group]
        print(f'{S_i.max():.3f} {S_i.idxmax():>22s} | {S_pred_i.idxmax():22s} {S_pred_i.max():.3f}')
    
    print('\n\n')
```


    
![png](/assets/images/galaxy-2/galaxy-2-3.png)
    


    ------|----------------------|----------------------|------
     prob |      meaning (exact) | meaning (pred)       | prob
    ------|----------------------|----------------------|------
    0.951                 Smooth | Smooth                 0.709
    0.035            Not edge on | Not edge on            0.249
    0.035                 No bar | No bar                 0.232
    0.035              No Spiral | Spiral                 0.043
    0.035  Just noticeable bulge | Obvious bulge          0.157
    0.952         No Odd Feature | No Odd Feature         0.782
    0.555             In between | In between             0.371
    0.024   Lens or arc (Oddity) | Other (Oddity)         0.064
    0.000          Rounded bulge | Rounded bulge          0.000
    0.000     Tightly wound arms | Medium wound arms      0.024
    0.000           1 Spiral Arm | Can't tell             0.031
    
    
    
    


    
![png](/assets/images/galaxy-2/galaxy-2-4.png)
    


    ------|----------------------|----------------------|------
     prob |      meaning (exact) | meaning (pred)       | prob
    ------|----------------------|----------------------|------
    0.444       Featured or disc | Smooth                 0.511
    0.444            Not edge on | Not edge on            0.360
    0.444                 No bar | No bar                 0.323
    0.270                 Spiral | Spiral                 0.001
    0.276          Obvious bulge | Obvious bulge          0.172
    0.781            Odd Feature | Odd Feature            0.558
    0.362       Completely round | Completely round       0.420
    0.601         Other (Oddity) | Other (Oddity)         0.336
    0.000          Rounded bulge | No bulge               0.001
    0.135      Medium wound arms | Medium wound arms      0.010
    0.270             Can't tell | 1 Spiral Arm           0.000
    
    
    
    


    
![png](/assets/images/galaxy-2/galaxy-2-5.png)
    


    ------|----------------------|----------------------|------
     prob |      meaning (exact) | meaning (pred)       | prob
    ------|----------------------|----------------------|------
    0.907       Featured or disc | Featured or disc       0.815
    0.868            Not edge on | Not edge on            0.611
    0.624                 No bar | No bar                 0.525
    0.668              No Spiral | Spiral                 0.093
    0.562          Obvious bulge | Obvious bulge          0.294
    0.859            Odd Feature | Odd Feature            1.121
    0.054           Cigar shaped | In between             0.045
    0.567        Merger (Oddity) | Merger (Oddity)        0.718
    0.039          Rounded bulge | Rounded bulge          0.109
    0.163     Tightly wound arms | Loose wound arms       0.040
    0.200             Can't tell | Can't tell             0.075
    
    
    
    


    
![png](/assets/images/galaxy-2/galaxy-2-6.png)
    


    ------|----------------------|----------------------|------
     prob |      meaning (exact) | meaning (pred)       | prob
    ------|----------------------|----------------------|------
    0.800                 Smooth | Smooth                 0.739
    0.175            Not edge on | Not edge on            0.174
    0.164                 No bar | No bar                 0.178
    0.141              No Spiral | Spiral                 0.000
    0.120          Obvious bulge | Obvious bulge          0.132
    0.874         No Odd Feature | No Odd Feature         0.785
    0.759       Completely round | Completely round       0.704
    0.076   Lens or arc (Oddity) | Other (Oddity)         0.096
    0.000          Rounded bulge | Rounded bulge          0.000
    0.034       Loose wound arms | Tightly wound arms     0.000
    0.034           1 Spiral Arm | 1 Spiral Arm           0.000
    
    
    
    


    
![png](/assets/images/galaxy-2/galaxy-2-7.png)
    


    ------|----------------------|----------------------|------
     prob |      meaning (exact) | meaning (pred)       | prob
    ------|----------------------|----------------------|------
    0.726                 Smooth | Smooth                 0.711
    0.187            Not edge on | Not edge on            0.244
    0.187                 No bar | No bar                 0.227
    0.187              No Spiral | Spiral                 0.036
    0.073  Just noticeable bulge | Obvious bulge          0.121
    0.547         No Odd Feature | No Odd Feature         0.827
    0.446       Completely round | Completely round       0.400
    0.226     Irregular (Oddity) | Other (Oddity)         0.061
    0.062          Rounded bulge | Rounded bulge          0.000
    0.000     Tightly wound arms | Tightly wound arms     0.036
    0.000           1 Spiral Arm | Can't tell             0.051
    
    
    
    


    
![png](/assets/images/galaxy-2/galaxy-2-8.png)
    


    ------|----------------------|----------------------|------
     prob |      meaning (exact) | meaning (pred)       | prob
    ------|----------------------|----------------------|------
    0.860       Featured or disc | Featured or disc       0.767
    0.840            Not edge on | Not edge on            0.707
    0.803                 No bar | No bar                 0.598
    0.583                 Spiral | Spiral                 0.388
    0.595  Just noticeable bulge | Just noticeable bulge  0.464
    0.922         No Odd Feature | No Odd Feature         0.880
    0.121             In between | In between             0.208
    0.052   Lens or arc (Oddity) | Other (Oddity)         0.043
    0.019               No bulge | Rounded bulge          0.040
    0.503     Tightly wound arms | Tightly wound arms     0.305
    0.371             Can't tell | Can't tell             0.233
    
    
    
    


    
![png](/assets/images/galaxy-2/galaxy-2-9.png)
    


    ------|----------------------|----------------------|------
     prob |      meaning (exact) | meaning (pred)       | prob
    ------|----------------------|----------------------|------
    0.613                 Smooth | Smooth                 0.830
    0.264            Not edge on | Not edge on            0.083
    0.264                 No bar | No bar                 0.086
    0.264              No Spiral | Spiral                 0.000
    0.251          Obvious bulge | Obvious bulge          0.070
    0.837         No Odd Feature | No Odd Feature         0.826
    0.518       Completely round | Completely round       0.674
    0.109         Other (Oddity) | Other (Oddity)         0.113
    0.059          Rounded bulge | Rounded bulge          0.000
    0.000     Tightly wound arms | Tightly wound arms     0.000
    0.000           1 Spiral Arm | 1 Spiral Arm           0.000
    
    
    
    


    
![png](/assets/images/galaxy-2/galaxy-2-10.png)
    


    ------|----------------------|----------------------|------
     prob |      meaning (exact) | meaning (pred)       | prob
    ------|----------------------|----------------------|------
    0.738       Featured or disc | Featured or disc       0.733
    0.738                Edge on | Edge on                0.666
    0.000     Bar through center | No bar                 0.049
    0.000                 Spiral | Spiral                 0.029
    0.623               No bulge | No bulge               0.365
    0.783         No Odd Feature | No Odd Feature         0.885
    0.249           Cigar shaped | Cigar shaped           0.249
    0.145     Dust lane (Oddity) | Other (Oddity)         0.063
    0.623               No bulge | No bulge               0.365
    0.000     Tightly wound arms | Medium wound arms      0.018
    0.000           1 Spiral Arm | Can't tell             0.004
    
    
    
    


    
![png](/assets/images/galaxy-2/galaxy-2-11.png)
    


    ------|----------------------|----------------------|------
     prob |      meaning (exact) | meaning (pred)       | prob
    ------|----------------------|----------------------|------
    0.683                 Smooth | Smooth                 0.705
    0.304            Not edge on | Not edge on            0.249
    0.304                 No bar | No bar                 0.232
    0.304              No Spiral | Spiral                 0.020
    0.304  Just noticeable bulge | Obvious bulge          0.150
    0.966         No Odd Feature | No Odd Feature         0.922
    0.620       Completely round | Completely round       0.660
    0.034   Lens or arc (Oddity) | Other (Oddity)         0.032
    0.000          Rounded bulge | Rounded bulge          0.000
    0.000     Tightly wound arms | Tightly wound arms     0.012
    0.000           1 Spiral Arm | Can't tell             0.008
    
    
    
    


    
![png](/assets/images/galaxy-2/galaxy-2-12.png)
    


    ------|----------------------|----------------------|------
     prob |      meaning (exact) | meaning (pred)       | prob
    ------|----------------------|----------------------|------
    0.741       Featured or disc | Featured or disc       0.735
    0.618            Not edge on | Not edge on            0.645
    0.618                 No bar | No bar                 0.544
    0.380                 Spiral | Spiral                 0.387
    0.499  Just noticeable bulge | Just noticeable bulge  0.460
    0.928         No Odd Feature | No Odd Feature         0.863
    0.189             In between | In between             0.189
    0.024          Ring (Oddity) | Irregular (Oddity)     0.046
    0.092          Rounded bulge | Rounded bulge          0.073
    0.380     Tightly wound arms | Tightly wound arms     0.184
    0.214             Can't tell | Can't tell             0.183
    
    
    
    
